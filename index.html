<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PaperStudio - 信笺纸设计工具</title>
    <script src="./static/tailwindcss.js"></script>
    <link href="./static/toastify.min.css" rel="stylesheet" />
    <script src="./static/fabric.min.js"></script>
    <script src="./static/jspdf.umd.min.js"></script>
    <script src="./static/svg2pdf.umd.min.js"></script>
    <script src="./static/opentype.min.js"></script>
    <link href="./static/icons.min.css" rel="stylesheet" />
    <script src="./static/hotkeys-js.min.js"></script>
    <script src="./static/toastify-js.js"></script>
    <link rel="preload" href="./static/SourceHanSerifCN-Bold.ttf" as="font" type="font/ttf" crossorigin />
    <style>
      /* 基础滚动条隐藏 */
      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }

      .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }

      /* 自定义滚动条样式 */
      .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }

      .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
      }

      .custom-scrollbar::-webkit-scrollbar-thumb {
        background-color: #cbd5e1;
        border-radius: 3px;
      }

      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background-color: #94a3b8;
      }

      /* UI 交互状态 */
      .tool-btn.active {
        background-color: #fee2e2;
        color: #e11d48;
        border-color: #e11d48;
      }

      /* 画布区域背景 */
      #scrollContainer {
        background-image: radial-gradient(#ddd 1px, transparent 1px);
        background-size: 20px 20px;
        display: block;
      }

      #zoomViewport {
        margin: 40px auto;
        transform-origin: 0 0;
        overflow: hidden;
        border-radius: 2px;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      }

      /* 图层列表样式 */
      .layer-item {
        border-left: 3px solid transparent;
      }

      .layer-item:hover {
        background-color: #f3f4f6;
      }

      .layer-item.active {
        background-color: #eff6ff;
        border-left-color: #3b82f6;
      }

      /* 模态框与卡片 */
      .modal-backdrop {
        background-color: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
      }

      .template-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      }

      /* 光标状态 */
      .canvas-container.grabbing-mode canvas {
        cursor: grabbing !important;
      }

      .canvas-container.grab-mode canvas {
        cursor: grab !important;
      }

      /* 紧凑型表单控件 */
      .compact-input {
        font-size: 12px;
        padding: 4px 6px;
        height: 28px;
      }

      .compact-label {
        color: #6b7280;
        margin-bottom: 2px;
        display: block;
      }

      /* 样式按钮 */
      .style-btn {
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .style-btn.active {
        background-color: #e5e7eb;
        font-weight: bold;
        color: #000;
      }

      /* 下拉菜单 */
      .dropdown:hover .dropdown-menu {
        display: block;
      }

      .dropdown-menu {
        display: none;
        position: absolute;
        background-color: white;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        z-index: 50;
        padding: 0.5rem;
        top: 100%;
        left: 0;
        width: 120px;
      }

      @font-face {
        font-family: "SourceHanSerifCN-Bold";
        src: url("./static/SourceHanSerifCN-Bold.ttf") format("truetype");
        font-weight: normal;
        font-style: normal;
        font-display: swap;
      }

      /* ========================================= */
      /* 打印专用样式 */
      /* ========================================= */

      #printContainer {
        display: none;
      }

      @media print {
        body > *:not(#printContainer) {
          display: none !important;
        }

        #printContainer {
          display: block !important;
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          z-index: 99999;
          background: white;
        }

        #printContainer img {
          width: 100%;
          height: auto;
          display: block;
        }
      }
    </style>
  </head>
  <body class="bg-gray-50 h-screen flex flex-col text-slate-700 font-sans overflow-hidden">
    <div id="welcomeModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop transition-opacity duration-300">
      <div class="bg-white w-[850px] h-[550px] rounded-2xl shadow-2xl flex overflow-hidden">
        <div class="w-1/3 bg-slate-900 text-white p-8 flex flex-col justify-between relative overflow-hidden">
          <div class="relative z-10">
            <div class="flex items-center gap-3 mb-8">
              <div class="bg-red-600 text-white p-2 rounded-lg">
                <i class="ph ph-article text-3xl"></i>
              </div>
              <div>
                <h1 class="text-xl font-bold tracking-tight">PaperStudio</h1>
                <p class="text-slate-400 text-xs">简单的信稿笺纸设计工具</p>
              </div>
            </div>
            <div class="space-y-4">
              <button onclick="App.templates.load('blank_a4')" class="w-full py-3 px-4 bg-red-600 hover:bg-red-700 rounded-xl flex items-center gap-3 transition group">
                <i class="ph ph-plus-circle text-xl"></i>
                <span class="font-medium">新建空白信纸</span>
              </button>
              <button onclick="document.getElementById('projectImportInput').click()" class="w-full py-3 px-4 bg-slate-800 hover:bg-slate-700 rounded-xl flex items-center gap-3 transition">
                <i class="ph ph-folder-open text-xl text-slate-400"></i>
                <span class="font-medium">打开信纸文件</span>
              </button>
            </div>
          </div>
          <a href="https://github.com/jingguanzhang/PaperStudio" target="_blank" class="relative z-20 flex items-center gap-2 text-slate-500 hover:text-white transition-colors cursor-pointer w-fit group">
            <i class="ph ph-github-logo text-2xl group-hover:scale-110 transition-transform"></i>
            <span class="text-xs font-medium">Github 源码</span>
          </a>
          <i class="ph ph-scroll absolute -bottom-5 -right-10 text-[200px] text-slate-800 opacity-50 rotate-12"></i>
        </div>
        <div class="w-2/3 p-8 bg-gray-50 flex flex-col">
          <h2 class="text-lg font-bold text-slate-800 mb-4 flex justify-between items-center">从模板开始</h2>
          <div id="templateGrid" class="grid grid-cols-2 gap-4 overflow-y-auto pr-2 custom-scrollbar"></div>
        </div>
      </div>
    </div>

    <input type="file" id="projectImportInput" hidden accept=".paper" />
    <input type="file" id="imgUpload" hidden accept="image/*" />
    <input type="file" id="imgReplaceInput" hidden accept="image/*" />

    <header class="h-14 bg-white border-b border-gray-200 flex items-center justify-between px-4 shadow-sm z-30 shrink-0 text-sm">
      <div class="flex items-center gap-4">
        <div class="flex items-center gap-2 text-slate-800 cursor-pointer" onclick="App.ui.showModal('welcomeModal')">
          <i class="ph ph-scroll text-2xl text-red-600"></i>
          <span class="font-bold tracking-tight">PaperStudio</span>
        </div>
        <div class="flex items-center gap-1">
          <button onclick="document.getElementById('projectImportInput').click()" class="hover:bg-gray-100 px-2 py-1 rounded font-medium flex items-center gap-1 transition text-slate-600" title="打开 (Ctrl+O)">
            <i class="ph ph-folder-open text-lg"></i> 打开
          </button>
          <button onclick="App.io.saveProject()" class="hover:bg-gray-100 px-2 py-1 rounded font-medium flex items-center gap-1 transition text-slate-600" title="保存 (Ctrl+S)">
            <i class="ph ph-floppy-disk text-lg"></i> 保存
          </button>
          <div class="w-px h-4 bg-gray-300 mx-1"></div>
          <button
            id="btnUndo"
            onclick="App.history.undo()"
            disabled
            class="hover:bg-gray-100 px-2 py-1 rounded font-medium flex items-center gap-1 transition text-slate-600 disabled:opacity-40 disabled:cursor-not-allowed disabled:hover:bg-transparent"
            title="撤销 (Ctrl+Z)"
          >
            <i class="ph ph-arrow-u-up-left text-lg"></i>
          </button>
          <button
            id="btnRedo"
            onclick="App.history.redo()"
            disabled
            class="hover:bg-gray-100 px-2 py-1 rounded font-medium flex items-center gap-1 transition text-slate-600 disabled:opacity-40 disabled:cursor-not-allowed disabled:hover:bg-transparent"
            title="重做 (Ctrl+Y)"
          >
            <i class="ph ph-arrow-u-up-right text-lg"></i>
          </button>
        </div>
      </div>

      <div class="flex items-center gap-1">
        <button onclick="App.tools.addText()" class="flex items-center gap-1 px-3 py-1.5 rounded hover:bg-gray-100 font-medium transition text-gray-600"><i class="ph ph-text-t text-lg"></i> 文字</button>
        <button onclick="App.tools.addParagraph()" class="flex items-center gap-1 px-3 py-1.5 rounded hover:bg-gray-100 font-medium transition text-gray-600"><i class="ph ph-text-align-justify text-lg"></i> 段落</button>

        <button onclick="document.getElementById('imgUpload').click()" class="flex items-center gap-1 px-3 py-1.5 rounded hover:bg-gray-100 font-medium transition text-gray-600">
          <i class="ph ph-image text-lg"></i> 图片
        </button>

        <div class="relative dropdown">
          <button class="flex items-center gap-1 px-3 py-1.5 rounded hover:bg-gray-100 font-medium transition text-gray-600">
            <i class="ph ph-article-ny-times text-lg"></i> 预设文本 <i class="ph ph-caret-down"></i>
          </button>
          <div class="dropdown-menu">
            <button onclick="App.tools.addDate()" class="flex items-center gap-1 px-3 py-1.5 rounded hover:bg-gray-100 font-medium transition text-gray-600"><i class="ph ph-calendar text-lg"></i> 日期</button>
            <button onclick="App.tools.addPageNum()" class="flex items-center gap-1 px-3 py-1.5 rounded hover:bg-gray-100 font-medium transition text-gray-600"><i class="ph ph-hash text-lg"></i> 页码</button>
          </div>
        </div>

        <div class="relative dropdown">
          <button class="flex items-center gap-1 px-3 py-1.5 rounded hover:bg-gray-100 font-medium transition text-gray-600"><i class="ph ph-shapes text-lg"></i> 图形 <i class="ph ph-caret-down"></i></button>
          <div class="dropdown-menu">
            <button onclick="App.tools.addLine()" class="flex items-center gap-1 px-3 py-1.5 rounded hover:bg-gray-100 font-medium transition text-gray-600"><i class="ph ph-line-segment text-lg"></i> 线条</button>
            <button onclick="App.tools.addShape('rect')" class="w-full text-left px-2 py-2 hover:bg-gray-100 flex items-center gap-2"><i class="ph ph-rectangle"></i> 矩形</button>
            <button onclick="App.tools.addShape('circle')" class="w-full text-left px-2 py-2 hover:bg-gray-100 flex items-center gap-2"><i class="ph ph-circle"></i> 圆形</button>
            <button onclick="App.tools.addShape('triangle')" class="w-full text-left px-2 py-2 hover:bg-gray-100 flex items-center gap-2"><i class="ph ph-triangle"></i> 三角形</button>
            <button onclick="App.tools.addShape('star')" class="w-full text-left px-2 py-2 hover:bg-gray-100 flex items-center gap-2"><i class="ph ph-star"></i> 角形</button>
          </div>
        </div>
      </div>

      <div class="w-80 flex justify-end gap-2">
        <button onclick="App.ui.toggleFullScreen()" class="flex items-center gap-1 px-3 py-1.5 rounded hover:bg-gray-100 text-md font-medium transition text-gray-600" title="全屏模式">
          <i id="fsIcon" class="ph ph-corners-out text-lg"></i>
        </button>
        <button onclick="App.io.exportPDF()" class="bg-white border border-red-200 text-red-600 hover:bg-red-50 px-3 py-1.5 rounded flex items-center gap-1 shadow-sm transition">
          <i class="ph ph-file-pdf text-lg"></i> 导出 PDF
        </button>
        <button onclick="App.io.print()" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded flex items-center gap-1 shadow-sm transition" title="打印 (Ctrl+P)">
          <i class="ph ph-printer text-lg"></i> 打印
        </button>
      </div>
    </header>

    <div class="flex-1 flex overflow-hidden">
      <aside class="w-64 bg-white border-r border-gray-200 flex flex-col z-20 overflow-y-auto no-scrollbar text-xs">
        <div class="p-4 space-y-6">
          <section>
            <h3 class="font-bold text-gray-400 uppercase tracking-wider mb-3 flex items-center gap-1 text-sm"><i class="ph ph-files"></i> 纸张布局</h3>
            <div class="space-y-3">
              <div>
                <label class="compact-label">纸张尺寸</label>
                <select id="paperSize" onchange="App.paper.updateSize()" class="w-full border-gray-300 rounded-md border p-2 bg-gray-50">
                  <option value="A3">A3 (297 × 420 mm)</option>
                  <option value="A4" selected>A4 (210 × 297 mm)</option>
                  <option value="A5">A5 (148 × 210 mm)</option>
                  <option value="B4">B4 (250 × 353 mm)</option>
                  <option value="B5">B5 (176 × 250 mm)</option>
                  <option value="Letter">Letter 美信</option>
                  <option value="Legal">Legal 美长</option>
                  <option value="16开">16开 (210 × 285 mm)</option>
                  <option value="32开">32开 (185 × 260 mm)</option>
                  <option value="方信笺纸">方信笺纸 (230 × 230 mm)</option>
                  <hr class="my-2 border-gray-300" />
                  <option value="CUSTOM">自定义尺寸…</option>
                </select>
                <label class="flex items-center gap-1 cursor-pointer mt-3 select-none">
                  <input type="checkbox" id="paperOrientation" class="accent-red-600 rounded scale-90" onchange="App.paper.updateSize()" />
                  <span class="text-gray-600">横向</span>
                </label>
              </div>
              <div id="customSizeInputs" class="grid grid-cols-2 gap-2 hidden">
                <div><label class="compact-label">宽 (mm)</label><input type="number" id="customW" value="210" class="w-full compact-input border rounded" /></div>
                <div><label class="compact-label">高 (mm)</label><input type="number" id="customH" value="297" class="w-full compact-input border rounded" /></div>
                <button onclick="App.paper.updateSize()" class="col-span-2 bg-gray-100 hover:bg-gray-200 py-1 rounded">应用尺寸</button>
              </div>
              <div class="grid grid-cols-2 gap-2">
                <div><label class="compact-label">上边距</label><input type="number" id="marginTop" value="35" min="0" class="w-full compact-input border border-gray-300 rounded" oninput="App.paper.drawGrid()" /></div>
                <div>
                  <label class="compact-label">下边距</label><input type="number" id="marginBottom" value="30" min="0" class="w-full compact-input border border-gray-300 rounded" oninput="App.paper.drawGrid()" />
                </div>
                <div><label class="compact-label">左边距</label><input type="number" id="marginLeft" value="22" min="0" class="w-full compact-input border border-gray-300 rounded" oninput="App.paper.drawGrid()" /></div>
                <div><label class="compact-label">右边距</label><input type="number" id="marginRight" value="22" min="0" class="w-full compact-input border border-gray-300 rounded" oninput="App.paper.drawGrid()" /></div>
              </div>
            </div>
          </section>
          <section>
            <div class="space-y-3">
              <div>
                <div class="flex justify-between mb-1">
                  <label class="compact-label">行数</label>
                  <span class="font-mono bg-red-50 text-red-600 px-1 rounded" id="rowCountDisplay">20</span>
                </div>
                <input type="range" id="rowCount" min="0" max="50" value="20" class="w-full accent-red-600 h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer" oninput="App.paper.updateSettings()" />
              </div>
              <div class="flex items-center gap-2">
                <div class="flex-1">
                  <label class="compact-label">背景颜色</label>
                  <div class="flex items-center gap-2">
                    <input type="color" id="paperBgColor" value="#ffffff" oninput="App.paper.drawGrid()" class="h-7 w-full p-0 border-0 rounded cursor-pointer" />
                    <button onclick="document.getElementById('paperBgColor').value='#ffffff'; App.paper.drawGrid()" class="px-2 py-1 bg-gray-100 hover:bg-gray-200 rounded text-xs" title="重置为白色">
                      <i class="ph ph-arrow-counter-clockwise"></i>
                    </button>
                  </div>
                </div>

                <div class="flex-1">
                  <label class="compact-label">行线颜色</label>
                  <input type="color" id="gridColor" value="#e11d48" class="h-7 w-full p-0 border-0 rounded cursor-pointer" oninput="App.paper.updateSettings()" />
                </div>
                <div class="w-16">
                  <label class="compact-label">线宽</label>
                  <input type="number" id="strokeWidth" value="1" min="1" max="5" class="w-full compact-input border rounded" oninput="App.paper.updateSettings()" />
                </div>
              </div>
              <div class="flex items-center gap-2 mt-2">
                <label class="flex items-center gap-2 cursor-pointer flex-1 select-none">
                  <input type="checkbox" id="gridDashed" class="accent-red-600 rounded scale-90" onchange="App.paper.updateSettings()" />
                  <span class="text-gray-600 compact-label mb-0">虚线</span>
                </label>
                <div class="w-16 relative">
                  <span class="text-gray-300 pointer-events-none">间距</span>
                  <input type="number" id="gridDashArray" value="4" min="1" max="20" class="w-full compact-input border rounded" oninput="App.paper.updateSettings()" />
                </div>
              </div>
              <div class="space-y-1">
                <label class="flex items-center gap-2 cursor-pointer"
                  ><input type="checkbox" id="doubleFirst" class="accent-red-600 rounded scale-90" onchange="App.paper.drawGrid()" checked /><span class="text-gray-600">首行双线</span></label
                >
                <label class="flex items-center gap-2 cursor-pointer"
                  ><input type="checkbox" id="doubleLast" class="accent-red-600 rounded scale-90" onchange="App.paper.drawGrid()" checked /><span class="text-gray-600">尾行双线</span></label
                >
              </div>
            </div>
          </section>
        </div>
      </aside>

      <main class="flex-1 bg-gray-200 relative flex flex-col overflow-hidden">
        <div class="absolute top-4 right-4 z-20 flex items-center bg-white shadow-lg rounded-lg p-1 border border-gray-200 text-xs">
          <button onclick="App.zoom.change(-0.1)" class="w-7 h-7 flex items-center justify-center text-gray-600 hover:bg-gray-100 rounded transition"><i class="ph ph-minus"></i></button>
          <span id="zoomPercent" class="font-mono w-12 text-center text-gray-600 font-bold">100%</span>
          <button onclick="App.zoom.change(0.1)" class="w-7 h-7 flex items-center justify-center text-gray-600 hover:bg-gray-100 rounded transition"><i class="ph ph-plus"></i></button>
          <div class="w-px h-3 bg-gray-300 mx-1"></div>
          <button onclick="App.zoom.autoFit()" class="w-7 h-7 flex items-center justify-center text-gray-600 hover:bg-gray-100 rounded transition" title="自适应"><i class="ph ph-arrows-out-simple"></i></button>
        </div>

        <div id="scrollContainer" class="flex-1 overflow-auto custom-scrollbar relative">
          <div id="zoomViewport">
            <div id="canvasWrapper" class="shadow-2xl bg-white relative">
              <canvas id="paperCanvas"></canvas>
              <button
                id="bgClearBtn"
                onclick="App.paper.clearBackground()"
                class="hidden absolute top-2 right-2 z-10 bg-white/90 hover:bg-red-50 text-gray-400 hover:text-red-600 rounded-full p-1 shadow-sm border border-gray-200 transition"
              >
                <i class="ph ph-trash text-lg"></i>
              </button>
            </div>
          </div>
        </div>

        <div class="h-5 bg-white border-t border-gray-200 flex items-center justify-between px-3 text-gray-400 shrink-0 z-20 text-xs">
          <span id="canvasSizeLabel">A4</span>
          <span class="flex items-center"><i class="ph ph-mouse-left-click"></i>拖动平移 | 滚轮缩放 | Shift+点击 多选 | Alt+拉框 多选</span>
        </div>
      </main>

      <aside class="w-64 bg-white border-l border-gray-200 flex flex-col z-20 h-full text-xs">
        <div class="flex-1 flex flex-col border-b border-gray-200 overflow-hidden" style="min-height: 45%">
          <div class="h-8 border-b border-gray-100 flex items-center px-3 bg-gray-50/50 shrink-0">
            <span class="font-bold text-gray-500 uppercase tracking-wider text-sm">选中属性</span>
          </div>

          <div id="noSelection" class="flex-1 flex flex-col items-center justify-center text-gray-300 p-8 text-center">
            <i class="ph ph-cursor-click text-4xl mb-2"></i>
            <p class="">选中元素以编辑</p>
          </div>

          <div id="selectionControls" class="hidden flex-1 overflow-y-auto p-3 space-y-4 text-xs">
            <section id="geoProps" class="border-b border-gray-100 pb-3">
              <div class="grid grid-cols-3 gap-2 mb-2">
                <div><label class="compact-label">X 坐标</label><input type="number" id="propX" class="w-full compact-input border rounded" onchange="App.ui.updateGeo('left', this.value)" /></div>
                <div><label class="compact-label">Y 坐标</label><input type="number" id="propY" class="w-full compact-input border rounded" onchange="App.ui.updateGeo('top', this.value)" /></div>
                <div><label class="compact-label">旋转°</label><input type="number" id="propAngle" class="w-full compact-input border rounded" onchange="App.ui.updateGeo('angle', this.value)" /></div>
              </div>
              <div class="grid grid-cols-2 gap-2">
                <div><label class="compact-label">宽度</label><input type="number" id="propW" class="w-full compact-input border rounded" onchange="App.ui.updateGeo('width', this.value)" /></div>
                <div><label class="compact-label">高度</label><input type="number" id="propH" class="w-full compact-input border rounded" onchange="App.ui.updateGeo('height', this.value)" /></div>
              </div>
            </section>

            <section id="commonProps" class="border-b border-gray-100 pb-3">
              <label class="compact-label flex justify-between"><span>透明度</span> <span id="opacityVal" class="text-gray-400">100%</span></label>
              <input
                type="range"
                id="propOpacity"
                min="0"
                max="1"
                step="0.01"
                oninput="App.ui.setProp('opacity', parseFloat(this.value)); 
                document.getElementById('opacityVal').innerText=Math.round(this.value*100)+'%'"
                class="w-full accent-slate-600 h-1 bg-gray-200 rounded appearance-none"
              />
            </section>

            <section id="alignTools" class="hidden border-b border-gray-100 pb-3">
              <h4 class="font-bold text-blue-600 mb-2">对齐与分布</h4>
              <div class="grid grid-cols-4 gap-1">
                <button onclick="App.ui.align('left')" class="py-1 border rounded hover:bg-blue-50" title="左对齐"><i class="ph ph-align-left"></i></button>
                <button onclick="App.ui.align('center')" class="py-1 border rounded hover:bg-blue-50" title="水平居中"><i class="ph ph-align-center-horizontal"></i></button>
                <button onclick="App.ui.align('right')" class="py-1 border rounded hover:bg-blue-50" title="右对齐"><i class="ph ph-align-right"></i></button>
                <button onclick="App.ui.distribute('horizontal')" class="py-1 border rounded hover:bg-blue-50" title="水平平均分布"><i class="ph ph-columns"></i></button>
                <button onclick="App.ui.align('top')" class="py-1 border rounded hover:bg-blue-50" title="顶对齐"><i class="ph ph-align-top"></i></button>
                <button onclick="App.ui.align('middle')" class="py-1 border rounded hover:bg-blue-50" title="垂直居中"><i class="ph ph-align-center-vertical"></i></button>
                <button onclick="App.ui.align('bottom')" class="py-1 border rounded hover:bg-blue-50" title="底对齐"><i class="ph ph-align-bottom"></i></button>
                <button onclick="App.ui.distribute('vertical')" class="py-1 border rounded hover:bg-blue-50" title="垂直平均分布"><i class="ph ph-rows"></i></button>
              </div>
            </section>

            <section id="textProps" class="hidden space-y-2">
              <div class="flex gap-1 items-end">
                <div class="flex-1">
                  <label class="compact-label">字体</label>
                  <select id="propFont" onchange="App.ui.setProp('fontFamily', this.value)" onclick="App.loadLocalFonts()" class="w-full compact-input border rounded bg-white">
                    <option value="SourceHanSerifCN-Bold" style="font-family: 'SourceHanSerifCN-Bold'">思源宋体</option>
                    <option value="SimSun">宋体</option>
                    <option value="KaiTi">楷体</option>
                    <option value="SimHei">黑体</option>
                    <option value="FangSong">仿宋</option>
                    <option value="Arial">Arial</option>
                    <option value="'Times New Roman'">Times New Roman</option>
                  </select>
                </div>
                <div class="w-16">
                  <label class="compact-label">字号</label>
                  <input type="number" id="propSize" oninput="App.ui.setProp('fontSize', Utils.pt2px(this.value))" class="w-full compact-input border rounded" />
                </div>
              </div>
              <div class="flex gap-2 items-center">
                <div class="flex border rounded overflow-hidden shrink-0">
                  <button id="btnBold" onclick="App.ui.toggleStyle('bold')" class="style-btn hover:bg-gray-50 border-r"><i class="ph ph-text-b"></i></button>
                  <button id="btnItalic" onclick="App.ui.toggleStyle('italic')" class="style-btn hover:bg-gray-50 border-r"><i class="ph ph-text-italic"></i></button>
                  <button id="btnUnderline" onclick="App.ui.toggleStyle('underline')" class="style-btn hover:bg-gray-50"><i class="ph ph-text-underline"></i></button>
                </div>
                <div class="flex-1 h-7 border rounded p-0.5 overflow-hidden flex items-center relative">
                  <input type="color" id="propColor" oninput="App.ui.setProp('fill', this.value)" class="absolute -top-2 -left-2 w-[150%] h-20 cursor-pointer p-0 border-0" />
                </div>
              </div>
              <div class="flex border rounded overflow-hidden flex-1">
                <button onclick="App.ui.setProp('textAlign', 'left')" class="flex-1 py-1 hover:bg-gray-50 border-r flex justify-center"><i class="ph ph-text-align-left"></i></button>
                <button onclick="App.ui.setProp('textAlign', 'center')" class="flex-1 py-1 hover:bg-gray-50 border-r flex justify-center"><i class="ph ph-text-align-center"></i></button>
                <button onclick="App.ui.setProp('textAlign', 'right')" class="flex-1 py-1 hover:bg-gray-50 flex justify-center"><i class="ph ph-text-align-right"></i></button>
              </div>
              <div>
                <label class="compact-label flex justify-between"><span>行高</span> <span id="lineHeightVal">1.2</span></label>
                <input
                  type="range"
                  id="propLineHeight"
                  min="0.5"
                  max="3.0"
                  step="0.1"
                  value="1.2"
                  oninput="App.ui.setProp('lineHeight', parseFloat(this.value)); document.getElementById('lineHeightVal').innerText=this.value"
                  class="w-full accent-slate-600 h-1 bg-gray-200 rounded appearance-none"
                />
              </div>
              <div>
                <label class="compact-label flex justify-between"><span>字间距</span> <span id="charSpacingVal">0</span></label>
                <input
                  type="range"
                  id="propCharSpacing"
                  min="-200"
                  max="1000"
                  step="10"
                  oninput="App.ui.setProp('charSpacing', parseInt(this.value)); document.getElementById('charSpacingVal').innerText=this.value"
                  class="w-full accent-slate-600 h-1 bg-gray-200 rounded appearance-none"
                />
              </div>
            </section>
            <section id="lineProps" class="hidden space-y-2">
              <div class="flex items-center gap-2">
                <div class="flex-1">
                  <label class="compact-label">线颜色</label>
                  <div class="flex-1 h-7 border rounded p-0.5 overflow-hidden flex items-center relative">
                    <input type="color" id="lineColor" oninput="App.ui.setProp('stroke', this.value)" class="absolute -top-2 -left-2 w-[150%] h-20 cursor-pointer p-0 border-0" />
                  </div>
                </div>
                <div class="w-16">
                  <label class="compact-label">线宽</label>
                  <input type="number" id="lineStrokeWidth" min="1" max="50" oninput="App.ui.setProp('strokeWidth', parseInt(this.value))" class="w-full compact-input border rounded" />
                </div>
              </div>

              <div class="flex items-center gap-2 pt-1 border-t border-gray-100">
                <label class="flex items-center gap-2 cursor-pointer flex-1 select-none">
                  <input type="checkbox" id="lineDashCheck" class="accent-slate-600 rounded scale-90" onchange="App.ui.updateLineDash()" />
                  <span class="text-gray-600 compact-label mb-0">虚线</span>
                </label>
                <div class="w-16">
                  <label class="compact-label">虚线间距</label>
                  <input type="number" id="lineDashVal" value="5" min="1" max="50" class="w-full compact-input border rounded" oninput="App.ui.updateLineDash()" />
                </div>
              </div>
            </section>

            <section id="shapeProps" class="hidden space-y-3 border-b border-gray-100 pb-3">
              <!-- 原有的填充/边框颜色控制保持不变 -->
              <div class="flex gap-2">
                <div class="flex-1">
                  <label class="compact-label">填充</label>
                  <div class="h-8 border rounded p-0.5 overflow-hidden relative bg-white">
                    <input type="color" id="shapeFill" oninput="App.ui.setProp('fill', this.value)" class="absolute -top-2 -left-2 w-[150%] h-16 cursor-pointer" />
                  </div>
                </div>
                <div class="flex-1">
                  <label class="compact-label">边框</label>
                  <div class="h-8 border rounded p-0.5 overflow-hidden relative bg-white">
                    <input type="color" id="shapeStroke" oninput="App.ui.setProp('stroke', this.value)" class="absolute -top-2 -left-2 w-[150%] h-16 cursor-pointer" />
                  </div>
                </div>
                <div class="w-16">
                  <label class="compact-label">线宽</label>
                  <input type="number" id="shapeStrokeWidth" min="0" max="20" class="w-full compact-input border rounded" oninput="App.ui.setProp('strokeWidth', parseInt(this.value))" />
                </div>
              </div>

              <!-- 新增：高级角控制区 (只对矩形/智能路径显示) -->
              <div id="rectCornerControl" class="hidden space-y-2 pt-2 border-t border-gray-200">
                <!-- 类型选择与总控 -->
                <div class="flex items-end gap-2">
                  <div class="w-1/3">
                    <label class="compact-label">角类型</label>
                    <select id="cornerStyle" onchange="App.tools.updateSmartCorner('style', this.value)" class="w-full compact-input border rounded bg-white">
                      <option value="round">圆角</option>
                      <option value="bevel">斜角</option>
                    </select>
                  </div>
                  <div class="flex-1">
                    <label class="compact-label flex justify-between"><span>角尺寸</span><span id="masterRadiusVal" class="text-xs text-gray-400">0</span></label>
                    <input
                      type="range"
                      id="masterRadius"
                      min="0"
                      max="100"
                      value="0"
                      oninput="App.tools.updateSmartCorner('all', this.value)"
                      class="w-full accent-red-600 h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                    />
                  </div>
                </div>

                <div class="grid grid-cols-2 gap-2 bg-gray-50 p-2 rounded border border-gray-200">
                  <div class="relative">
                    <span class="absolute left-1 top-1 text-[10px] text-gray-400">左上</span>
                    <input type="number" id="cornerTL" min="0" oninput="App.tools.updateSmartCorner('tl', this.value)" class="w-full compact-input border rounded text-right pl-6" />
                  </div>
                  <div class="relative">
                    <span class="absolute left-1 top-1 text-[10px] text-gray-400">右上</span>
                    <input type="number" id="cornerTR" min="0" oninput="App.tools.updateSmartCorner('tr', this.value)" class="w-full compact-input border rounded text-right pl-6" />
                  </div>
                  <div class="relative">
                    <span class="absolute left-1 top-1 text-[10px] text-gray-400">左下</span>
                    <input type="number" id="cornerBL" min="0" oninput="App.tools.updateSmartCorner('bl', this.value)" class="w-full compact-input border rounded text-right pl-6" />
                  </div>
                  <div class="relative">
                    <span class="absolute left-1 top-1 text-[10px] text-gray-400">右下</span>
                    <input type="number" id="cornerBR" min="0" oninput="App.tools.updateSmartCorner('br', this.value)" class="w-full compact-input border rounded text-right pl-6" />
                  </div>
                </div>
              </div>
            </section>

            <section id="imgProps" class="hidden">
              <button onclick="document.getElementById('imgReplaceInput').click()" class="w-full py-2 bg-gray-100 text-slate-700 border border-gray-300 rounded font-medium hover:bg-gray-200 transition mb-2">
                <i class="ph ph-arrows-clockwise"></i> 替换图片
              </button>

              <button onclick="App.tools.setAsBackground()" class="w-full py-2 bg-blue-50 text-blue-600 border border-blue-200 rounded font-medium hover:bg-blue-100 transition mb-3">
                <i class="ph ph-image-square"></i> 设为背景图片
              </button>
            </section>

            <section id="fineTuneTools">
              <h4 class="font-bold text-gray-400 mb-2 border-t pt-2">微调与布局</h4>
              <div class="grid grid-cols-3 gap-1 mb-2 w-28 mx-auto">
                <button onclick="App.tools.flip('x')" class="py-1.5 border rounded hover:bg-gray-50 flex items-center justify-center gap-1">
                  <i class="ph ph-flip-horizontal"></i>
                </button>
                <button onclick="App.tools.nudge('up')" class="p-1 border rounded hover:bg-gray-100 flex items-center justify-center h-7"><i class="ph ph-caret-up"></i></button>
                <button onclick="App.tools.flip('y')" class="py-1.5 border rounded hover:bg-gray-50 flex items-center justify-center gap-1">
                  <i class="ph ph-flip-vertical"></i>
                </button>
                <button onclick="App.tools.nudge('left')" class="p-1 border rounded hover:bg-gray-100 flex items-center justify-center h-7"><i class="ph ph-caret-left"></i></button>
                <button onclick="App.tools.nudge('down')" class="p-1 border rounded hover:bg-gray-100 flex items-center justify-center h-7"><i class="ph ph-caret-down"></i></button>
                <button onclick="App.tools.nudge('right')" class="p-1 border rounded hover:bg-gray-100 flex items-center justify-center h-7"><i class="ph ph-caret-right"></i></button>
                <button onclick="App.ui.alignObject('left')" class="p-1 border rounded hover:bg-gray-100 flex items-center justify-center h-7"><i class="ph ph-align-left-simple"></i></button>
                <button onclick="App.ui.alignObject('centerH')" class="p-1 border rounded hover:bg-gray-100 flex items-center justify-center h-7"><i class="ph ph-align-center-horizontal-simple"></i></button>
                <button onclick="App.ui.alignObject('right')" class="p-1 border rounded hover:bg-gray-100 flex items-center justify-center h-7"><i class="ph ph-align-right-simple"></i></button>
              </div>
            </section>
          </div>
        </div>

        <div class="flex-1 flex flex-col overflow-hidden bg-gray-50/50">
          <div class="h-8 border-b border-gray-200 flex items-center px-3 bg-gray-100 shrink-0"><span class="font-bold text-gray-500 uppercase text-sm">图层</span></div>
          <div id="layerList" class="flex-1 overflow-y-auto p-1 space-y-0.5 custom-scrollbar"></div>
          <div class="h-9 border-t border-gray-200 bg-white flex items-center justify-around px-2 shrink-0">
            <button class="p-1 text-gray-500 hover:text-blue-600 hover:bg-blue-50 rounded" onclick="App.ui.moveLayer('up')" title="上移"><i class="ph ph-arrow-up"></i></button>
            <button class="p-1 text-gray-500 hover:text-blue-600 hover:bg-blue-50 rounded" onclick="App.ui.moveLayer('down')" title="下移"><i class="ph ph-arrow-down"></i></button>
            <div class="w-px h-3 bg-gray-300"></div>
            <button class="p-1 text-gray-500 hover:text-red-600 hover:bg-red-50 rounded" onclick="App.tools.deleteActive()" title="删除 (Delete)"><i class="ph ph-trash"></i></button>
          </div>
        </div>
      </aside>
    </div>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="hidden fixed inset-0 z-[60] bg-white/80 backdrop-blur-sm flex flex-col items-center justify-center">
      <div class="animate-spin rounded-full h-12 w-12 border-4 border-red-600 border-t-transparent"></div>
      <p class="mt-4 text-slate-600 font-medium animate-pulse">正在加载模板...</p>
    </div>
    <script>
      /**
       * PaperStudio Logic
       * 优化版 - 保持原有功能完整
       */

      // --- 1. 配置与工具 ---
      const CONFIG = {
        DPI: 96,
        MM_TO_PX: 3.7795,
        PT_TO_PX: 1.3333,
        SIZES: {
          A3: { w: 297, h: 420 },
          A4: { w: 210, h: 297 },
          A5: { w: 148, h: 210 },
          B4: { w: 250, h: 353 },
          B5: { w: 176, h: 250 },
          Letter: { w: 215.9, h: 279.4 },
          Legal: { w: 215.9, h: 355.6 },
          "16开": { w: 210, h: 285 },
          "32开": { w: 185, h: 260 },
          方信笺纸: { w: 230, h: 230 },
        },
      };

      const Utils = {
        mm2px: (mm) => mm * CONFIG.MM_TO_PX,
        px2mm: (px) => px / CONFIG.MM_TO_PX,
        pt2px: (pt) => Math.round(pt * CONFIG.PT_TO_PX),
        px2pt: (px) => Math.round(px / CONFIG.PT_TO_PX),

        toast: (text, type = "info") => {
          const bg = type === "error" ? "linear-gradient(to right, #ff5f6d, #ffc371)" : type === "success" ? "linear-gradient(to right, #00b09b, #96c93d)" : "#333";
          Toastify({
            text,
            duration: 3000,
            gravity: "top",
            position: "center",
            style: { background: bg, borderRadius: "8px", fontSize: "12px", boxShadow: "0 4px 6px rgba(0,0,0,0.1)" },
          }).showToast();
        },

        throttle: (func, limit) => {
          let inThrottle;
          return function () {
            const args = arguments,
              context = this;
            if (!inThrottle) {
              func.apply(context, args);
              inThrottle = true;
              setTimeout(() => (inThrottle = false), limit);
            }
          };
        },

        generateSmartRectPath: (w, h, r, style) => {
          const maxR = Math.min(w, h) / 2;
          const tl = Math.min(r.tl, maxR),
            tr = Math.min(r.tr, maxR),
            br = Math.min(r.br, maxR),
            bl = Math.min(r.bl, maxR);

          let path = `M ${tl} 0 L ${w - tr} 0 `;

          if (style === "round") {
            path += tr > 0 ? `A ${tr} ${tr} 0 0 1 ${w} ${tr} ` : `L ${w} 0 `;
            path += `L ${w} ${h - br} `;
            path += br > 0 ? `A ${br} ${br} 0 0 1 ${w - br} ${h} ` : `L ${w} ${h} `;
            path += `L ${bl} ${h} `;
            path += bl > 0 ? `A ${bl} ${bl} 0 0 1 0 ${h - bl} ` : `L 0 ${h} `;
            path += `L 0 ${tl} `;
            path += tl > 0 ? `A ${tl} ${tl} 0 0 1 ${tl} 0 ` : `L 0 0 `;
          } else {
            // Bevel
            path += `L ${w} ${tr} L ${w} ${h - br} L ${w - br} ${h} L ${bl} ${h} L 0 ${h - bl} L 0 ${tl} L ${tl} 0 `;
          }
          return path + "Z";
        },
      };

      // --- 2. App 主逻辑 ---
      const App = {
        canvas: null,
        state: {
          currentPaper: { ...CONFIG.SIZES["A4"] },
          baseWidth: 0,
          baseHeight: 0,
          zoom: 1,
          isPanning: false,
          clipboard: null,
          pasteCount: 0,
          selectionQueue: [],
          localFontsLoaded: false,
          hasUnsavedChanges: false,
        },

        init: function () {
          this.canvas = new fabric.Canvas("paperCanvas", {
            backgroundColor: "#fff",
            preserveObjectStacking: true,
            selection: true,
            enableRetinaScaling: true,
            fireRightClick: true,
            stopContextMenu: true,
            defaultCursor: "default",
            hoverCursor: "move",
          });

          fabric.Object.prototype.set({
            borderColor: "#3b82f6",
            borderScaleFactor: 1.5,
            cornerColor: "white",
            cornerStrokeColor: "#3b82f6",
            borderOpacityWhenMoving: 1,
            cornerSize: 8,
            transparentCorners: false,
            centeredScaling: false,
            uniformScaling: false,
            uniScaleKey: "shiftKey",
          });

          this.paper.init();
          this.events.initCanvasEvents();
          this.history.init();
          this.zoom.autoFit();

          if ("queryLocalFonts" in window) setTimeout(() => this.loadLocalFonts(), 1000);
        },

        // --- 历史记录 ---
        history: {
          stack: [],
          index: -1,
          locked: false,
          maxSteps: 20,

          init: function () {
            const saveHandler = (e) => {
              if (!this.locked && (!e || !e.target.isGrid)) this.saveState();
            };
            App.canvas.on({
              "object:modified": saveHandler,
              "object:added": saveHandler,
              "object:removed": saveHandler,
            });
          },

          updateUI: function () {
            const btnUndo = document.getElementById("btnUndo");
            const btnRedo = document.getElementById("btnRedo");
            if (btnUndo && btnRedo) {
              btnUndo.disabled = this.index <= 0;
              btnRedo.disabled = this.index >= this.stack.length - 1;
            }
          },

          saveState: function () {
            if (this.locked) return;
            if (this.index < this.stack.length - 1) {
              this.stack = this.stack.slice(0, this.index + 1);
            }

            const json = App.canvas.toJSON(["id", "isGrid", "selectable", "evented", "lockMovementX", "lockMovementY", "cornerConfig", "isSmartRect"]);
            json.objects = json.objects.filter((o) => !o.isGrid);

            this.stack.push(JSON.stringify(json));
            if (this.stack.length > this.maxSteps) this.stack.shift();
            else this.index++;

            this.updateUI();
            App.state.hasUnsavedChanges = true;
          },

          reset: function () {
            this.stack = [];
            this.index = -1;
            this.locked = false;
            this.saveState();
          },

          undo: function () {
            if (this.index <= 0) return;
            this.load(this.stack[--this.index]);
          },

          redo: function () {
            if (this.index >= this.stack.length - 1) return;
            this.load(this.stack[++this.index]);
          },

          load: function (jsonStr) {
            this.locked = true;
            App.canvas.loadFromJSON(jsonStr, () => {
              App.paper.drawGrid();
              App.canvas.renderAll();
              App.ui.updateLayerList();
              App.ui.updateInspector();
              this.locked = false;
              this.updateUI();
            });
          },
        },

        // --- 纸张与网格 ---
        paper: {
          init: function () {
            this.updateSize();
          },

          getSettings: function () {
            const el = (id) => document.getElementById(id);
            const val = (id, def) => (el(id) ? el(id).value : def);
            const chk = (id) => (el(id) ? el(id).checked : false);

            return {
              marginTop: parseInt(val("marginTop", 37)) * CONFIG.MM_TO_PX,
              marginBottom: parseInt(val("marginBottom", 35)) * CONFIG.MM_TO_PX,
              marginLeft: parseInt(val("marginLeft", 28)) * CONFIG.MM_TO_PX,
              marginRight: parseInt(val("marginRight", 26)) * CONFIG.MM_TO_PX,
              rowCount: parseInt(val("rowCount", 20)),
              gridColor: val("gridColor", "#e11d48"),
              strokeWidth: parseInt(val("strokeWidth", 1)),
              doubleFirst: chk("doubleFirst"),
              doubleLast: chk("doubleLast"),
              gridDashed: chk("gridDashed"),
              gridDashArray: parseInt(val("gridDashArray", 4)),
              paperBgColor: val("paperBgColor", "#ffffff"),
            };
          },

          updateSize: function () {
            const type = document.getElementById("paperSize").value;
            const customDiv = document.getElementById("customSizeInputs");
            let w, h;

            if (type === "CUSTOM") {
              customDiv.classList.remove("hidden");
              w = parseInt(document.getElementById("customW").value) || 210;
              h = parseInt(document.getElementById("customH").value) || 297;
            } else {
              customDiv.classList.add("hidden");
              w = CONFIG.SIZES[type].w;
              h = CONFIG.SIZES[type].h;
            }

            const isLandscape = document.getElementById("paperOrientation").checked;
            App.state.currentPaper.w = isLandscape ? Math.max(w, h) : Math.min(w, h);
            App.state.currentPaper.h = isLandscape ? Math.min(w, h) : Math.max(w, h);

            App.state.baseWidth = App.state.currentPaper.w * CONFIG.MM_TO_PX;
            App.state.baseHeight = App.state.currentPaper.h * CONFIG.MM_TO_PX;

            document.getElementById("canvasSizeLabel").innerText = `${type} - ${isLandscape ? "横向" : "纵向"} (${App.state.currentPaper.w} x ${App.state.currentPaper.h} mm)`;

            App.zoom.apply(App.state.zoom);
            App.state.hasUnsavedChanges = true;
            this.drawGrid();
          },

          updateSettings: function () {
            const rc = document.getElementById("rowCount");
            if (rc) document.getElementById("rowCountDisplay").innerText = rc.value;
            App.state.hasUnsavedChanges = true;
            this.drawGrid();
          },

          drawGrid: function () {
            const cfg = this.getSettings();
            const canvas = App.canvas;
            canvas.setBackgroundColor(cfg.paperBgColor, canvas.requestRenderAll.bind(canvas));

            // 清除旧网格
            canvas.remove(...canvas.getObjects().filter((o) => o.isGrid));

            if (cfg.rowCount === 0) {
              canvas.requestRenderAll();
              return;
            }

            const contentHeight = App.state.baseHeight - cfg.marginTop - cfg.marginBottom;
            const lineHeight = contentHeight / cfg.rowCount;
            const startX = cfg.marginLeft,
              endX = App.state.baseWidth - cfg.marginRight;
            const gridLines = [];

            const addLine = (y, w, opts = {}) => {
              gridLines.push(
                new fabric.Line([startX, y, endX, y], {
                  stroke: cfg.gridColor,
                  strokeWidth: w,
                  selectable: false,
                  evented: false,
                  isGrid: true,
                  excludeFromExport: true,
                  originX: "center",
                  originY: "center",
                  ...opts,
                })
              );
            };

            for (let i = 0; i <= cfg.rowCount; i++) {
              const y = cfg.marginTop + i * lineHeight;
              if (i === 0 && cfg.doubleFirst) {
                addLine(y - 2, 3);
                addLine(y + 2, 1);
              } else if (i === cfg.rowCount && cfg.doubleLast) {
                addLine(y - 2, 1);
                addLine(y + 2, 3);
              } else {
                addLine(y, cfg.strokeWidth, cfg.gridDashed && i > 0 && i < cfg.rowCount ? { strokeDashArray: [cfg.gridDashArray, cfg.gridDashArray] } : {});
              }
            }

            gridLines.forEach((l) => {
              canvas.add(l);
              canvas.sendToBack(l);
            });
            canvas.requestRenderAll();
          },

          clearBackground: function () {
            App.canvas.setBackgroundImage(null, () => {
              App.canvas.requestRenderAll();
              document.getElementById("bgClearBtn").classList.add("hidden");
              App.ui.updateLayerList();
              App.state.hasUnsavedChanges = true;
              App.history.saveState();
            });
          },
        },

        // --- 缩放管理 ---
        zoom: {
          change: function (delta, point) {
            const oldScale = App.state.zoom;
            const newScale = Math.max(0.1, Math.min(4.0, oldScale + delta));
            if (newScale === oldScale) return;

            this.apply(newScale);

            if (point) {
              const container = document.getElementById("scrollContainer");
              const factor = newScale / oldScale;
              container.scrollLeft = (container.scrollLeft + point.x) * factor - point.x;
              container.scrollTop = (container.scrollTop + point.y) * factor - point.y;
            }
          },

          autoFit: function () {
            const container = document.getElementById("scrollContainer");
            const scale = Math.min(1.2, Math.min((container.clientWidth - 60) / App.state.baseWidth, (container.clientHeight - 60) / App.state.baseHeight));

            this.apply(scale);
            setTimeout(() => {
              container.scrollLeft = (App.state.baseWidth * scale - container.clientWidth) / 2 + 30;
              container.scrollTop = (App.state.baseHeight * scale - container.clientHeight) / 2 + 30;
            }, 0);
          },

          apply: function (scale) {
            App.state.zoom = scale;
            const w = Math.round(App.state.baseWidth * scale);
            const h = Math.round(App.state.baseHeight * scale);
            App.canvas.setDimensions({ width: w, height: h }).setZoom(scale);

            const vp = document.getElementById("zoomViewport");
            if (vp) {
              vp.style.width = w + "px";
              vp.style.height = h + "px";
            }
            document.getElementById("zoomPercent").innerText = Math.round(scale * 100) + "%";
            App.canvas.requestRenderAll();
          },
        },

        // --- 事件处理 ---
        events: {
          initCanvasEvents: function () {
            const container = document.getElementById("scrollContainer");
            let startX = 0,
              startY = 0,
              scrollLeft = 0,
              scrollTop = 0;
            let dragOrigin = null,
              isDragThresholdPassed = false;

            // 1. 拖拽与平移
            App.canvas.on("mouse:down", (opt) => {
              const target = opt.target;
              if (target && !opt.e.altKey && !target.isGrid) {
                dragOrigin = { left: target.left, top: target.top };
                isDragThresholdPassed = false;
              } else {
                dragOrigin = null;
              }

              if (!target || target.isGrid) {
                if (opt.e.altKey) {
                  App.state.isPanning = false;
                  App.canvas.selection = true;
                  App.canvas.defaultCursor = "default";
                } else {
                  App.state.isPanning = true;
                  App.canvas.selection = false;
                  startX = opt.e.clientX;
                  startY = opt.e.clientY;
                  scrollLeft = container.scrollLeft;
                  scrollTop = container.scrollTop;
                  App.canvas.defaultCursor = "grabbing";
                  App.canvas.setCursor("grabbing");
                }
              }
            });

            App.canvas.on("object:moving", (opt) => {
              if (dragOrigin && !isDragThresholdPassed) {
                if (Math.abs(opt.target.left - dragOrigin.left) < 3 && Math.abs(opt.target.top - dragOrigin.top) < 3) {
                  opt.target.set({ left: dragOrigin.left, top: dragOrigin.top });
                } else {
                  isDragThresholdPassed = true;
                }
              }
            });

            App.canvas.on("mouse:up", () => {
              dragOrigin = null;
              isDragThresholdPassed = false;
              if (App.state.isPanning) {
                App.state.isPanning = false;
                App.canvas.selection = true;
                App.canvas.defaultCursor = "default";
              }
            });

            document.addEventListener(
              "mousemove",
              (e) => {
                if (App.state.isPanning) {
                  e.preventDefault();
                  container.scrollLeft = scrollLeft - (e.clientX - startX);
                  container.scrollTop = scrollTop - (e.clientY - startY);
                } else if (App.canvas && App.canvas._currentTransform) {
                  e.preventDefault();
                }
              },
              { passive: false }
            );

            // 2. 滚轮缩放
            container.addEventListener(
              "wheel",
              (e) => {
                e.preventDefault();
                e.stopPropagation();
                const rect = container.getBoundingClientRect();
                App.zoom.change(e.deltaY > 0 ? -0.1 : 0.1, { x: e.clientX - rect.left, y: e.clientY - rect.top });
              },
              { passive: false }
            );

            // 3. 选中与UI同步
            const updateQueue = (sel, desel) => {
              if (sel) sel.forEach((o) => !App.state.selectionQueue.includes(o) && App.state.selectionQueue.push(o));
              if (desel)
                desel.forEach((o) => {
                  const idx = App.state.selectionQueue.indexOf(o);
                  if (idx > -1) App.state.selectionQueue.splice(idx, 1);
                });
              App.ui.updateInspector();
            };

            App.canvas.on({
              "selection:created": (e) => updateQueue(e.selected, null),
              "selection:updated": (e) => updateQueue(e.selected, e.deselected),
              "selection:cleared": () => {
                App.state.selectionQueue = [];
                App.ui.updateInspector();
              },
              "object:modified": () => App.ui.updateInspector(),
            });

            // 4. 对象变换处理 (字体大小随缩放调整)
            const geoUpdate = (e) => {
              const t = e.target;
              if (["i-text", "textbox", "text"].includes(t.type) && Math.abs(t.scaleX - t.scaleY) < 0.01 && Math.abs(t.scaleX - 1) > 0.001) {
                const newSize = t.fontSize * t.scaleX;
                t.set({ fontSize: newSize, scaleX: 1, scaleY: 1 });
                if (t.type === "textbox") t.width *= t.scaleX;
                const propSize = document.getElementById("propSize");
                if (propSize) propSize.value = Utils.px2pt(newSize);
              }
              App.ui.updateGeo(null, null, t);
            };

            App.canvas.on({ "object:moving": geoUpdate, "object:scaling": geoUpdate, "object:rotating": geoUpdate, "object:resizing": geoUpdate });

            container.addEventListener("mousedown", (e) => {
              if (["scrollContainer", "zoomViewport", "canvasWrapper"].includes(e.target.id)) {
                App.canvas.discardActiveObject();
                App.canvas.requestRenderAll();
                App.ui.updateInspector();
              }
            });

            window.addEventListener(
              "resize",
              Utils.throttle(() => App.zoom.autoFit(), 200)
            );
          },
        },

        // --- 本地字体加载 ---
        loadLocalFonts: async function () {
          if (App.state.localFontsLoaded || !window.queryLocalFonts) return;
          try {
            App.state.localFontsLoaded = true;
            const fonts = (await window.queryLocalFonts()).sort((a, b) => a.family.localeCompare(b.family));
            const select = document.getElementById("propFont");
            const seen = new Set([...select.options].map((o) => o.value));

            if (!seen.has("---sep---")) select.add(new Option("--- 本地字体 ---", "---sep---", true, true));

            let count = 0;
            for (const f of fonts) {
              if (!seen.has(f.family)) {
                seen.add(f.family);
                const opt = new Option(f.fullName, f.family);
                opt.style.fontFamily = f.family;
                select.add(opt);
                count++;
              }
            }
            if (count) Utils.toast(`已加载 ${count} 款本地字体`);
          } catch (e) {
            console.warn("Font Access Error", e);
            App.state.localFontsLoaded = false;
          }
        },

        // --- 工具集 ---
        tools: {
          _getCenter: () => ({ left: App.state.baseWidth / 2, top: App.state.baseHeight / 2 }),

          _addToCanvas: function (obj) {
            App.canvas.add(obj);
            App.canvas.setActiveObject(obj);
            App.canvas.requestRenderAll();
            App.ui.updateLayerList();
            App.history.saveState();
          },

          addText: function () {
            this._addToCanvas(
              new fabric.IText("点击编辑文本", {
                ...this._getCenter(),
                fontSize: Utils.pt2px(14),
                fontFamily: "SimSun",
                fill: App.paper.getSettings().gridColor,
                originX: "center",
                originY: "center",
              })
            );
          },

          addParagraph: function () {
            this._addToCanvas(
              new fabric.Textbox("在此输入段落文本...\n支持自动换行。", {
                ...this._getCenter(),
                width: App.state.baseWidth - Utils.mm2px(50),
                fontSize: Utils.pt2px(12),
                fontFamily: "FangSong",
                fill: "#333",
                splitByGrapheme: true,
                originX: "center",
                originY: "center",
              })
            );
          },

          addDate: function () {
            const cfg = App.paper.getSettings();
            this._addToCanvas(
              new fabric.IText("____年__月__日", {
                left: App.state.baseWidth - cfg.marginRight,
                top: cfg.marginTop - 35,
                fontSize: Utils.pt2px(14),
                fontFamily: "KaiTi",
                fill: cfg.gridColor,
                originX: "right",
              })
            );
          },

          addPageNum: function () {
            this._addToCanvas(
              new fabric.IText("第   页", {
                left: App.state.baseWidth / 2,
                top: App.state.baseHeight - Utils.mm2px(20),
                fontSize: Utils.pt2px(12),
                fontFamily: "SimSun",
                fill: App.paper.getSettings().gridColor,
                originX: "center",
                originY: "center",
              })
            );
          },

          addLine: function () {
            const cfg = App.paper.getSettings();
            this._addToCanvas(
              new fabric.Line([0, 0, App.state.baseWidth - cfg.marginLeft - cfg.marginRight, 0], {
                ...this._getCenter(),
                stroke: cfg.gridColor,
                strokeWidth: 2,
                originX: "center",
                originY: "center",
              })
            );
          },

          addShape: function (type) {
            const comm = { ...this._getCenter(), fill: App.paper.getSettings().gridColor, strokeWidth: 0, originX: "center", originY: "center" };
            let obj;
            if (type === "rect") obj = new fabric.Rect({ ...comm, width: 100, height: 100 });
            else if (type === "circle") obj = new fabric.Circle({ ...comm, radius: 50 });
            else if (type === "triangle") obj = new fabric.Triangle({ ...comm, width: 100, height: 100 });
            else if (type === "star") {
              const pts = [];
              for (let i = 0; i < 10; i++) {
                const r = i % 2 === 0 ? 50 : 19.1;
                const a = (Math.PI * i) / 5 - Math.PI / 2;
                pts.push({ x: Math.cos(a) * r, y: Math.sin(a) * r });
              }
              obj = new fabric.Polygon(pts, { ...comm, fill: comm.fill });
            }
            if (obj) this._addToCanvas(obj);
          },

          handleImageUpload: function (input) {
            if (input.files?.[0]) {
              const reader = new FileReader();
              reader.onload = (e) =>
                fabric.Image.fromURL(e.target.result, (img) => {
                  img.scaleToWidth(Utils.mm2px(50));
                  img.set({ ...this._getCenter(), originX: "center", originY: "center" });
                  this._addToCanvas(img);
                  input.value = "";
                });
              reader.readAsDataURL(input.files[0]);
            }
          },

          replaceActiveImage: function (input) {
            const act = App.canvas.getActiveObject();
            if (!act || act.type !== "image" || !input.files?.[0]) return;
            const reader = new FileReader();
            reader.onload = (e) =>
              act.setSrc(e.target.result, () => {
                App.canvas.renderAll();
                App.ui.updateLayerList();
                App.history.saveState();
                Utils.toast("图片已替换");
              });
            reader.readAsDataURL(input.files[0]);
            input.value = "";
          },

          setAsBackground: function () {
            const act = App.canvas.getActiveObject();
            if (act && act.type === "image") {
              App.canvas.setBackgroundImage(
                act,
                () => {
                  App.canvas.remove(act);
                  App.canvas.requestRenderAll();
                  document.getElementById("bgClearBtn").classList.remove("hidden");
                  App.ui.updateLayerList();
                  App.state.hasUnsavedChanges = true;
                  App.history.saveState();
                  Utils.toast("已设为背景");
                },
                { ...act.toObject(["originX", "originY", "left", "top", "scaleX", "scaleY", "angle", "opacity"]) }
              );
            } else Utils.toast("请先选中一张图片", "error");
          },

          deleteActive: function () {
            const act = App.canvas.getActiveObject();
            if (!act) return;
            if (act.type === "activeSelection") act.forEachObject((o) => App.canvas.remove(o));
            else App.canvas.remove(act);
            App.canvas.discardActiveObject();
            App.ui.updateLayerList();
            App.ui.updateInspector();
            App.history.saveState();
          },

          nudge: function (dir) {
            const act = App.canvas.getActiveObject();
            if (!act) return;
            if (dir === "up") act.top -= 2;
            else if (dir === "down") act.top += 2;
            if (dir === "left") act.left -= 2;
            else if (dir === "right") act.left += 2;
            act.setCoords();
            App.canvas.requestRenderAll();
            App.ui.updateGeo(null, null, act);
          },

          updateSmartCorner: function (key, value) {
            const act = App.canvas.getActiveObject();
            if (!act || (act.type !== "rect" && !act.isSmartRect)) return;

            let cfg = act.cornerConfig || { tl: 0, tr: 0, bl: 0, br: 0, style: "round" };
            if (key === "all") {
              const v = parseInt(value) || 0;
              cfg.tl = cfg.tr = cfg.bl = cfg.br = v;
              ["tl", "tr", "bl", "br"].forEach((k) => (document.getElementById("corner" + k.toUpperCase()).value = v));
              document.getElementById("masterRadiusVal").innerText = v;
            } else if (key === "style") cfg.style = value;
            else cfg[key] = parseInt(value) || 0;

            const newObj = new fabric.Path(Utils.generateSmartRectPath(act.getScaledWidth(), act.getScaledHeight(), cfg, cfg.style), {
              ...act.toObject(["left", "top", "fill", "stroke", "strokeWidth", "opacity", "angle", "originX", "originY"]),
              scaleX: 1,
              scaleY: 1,
              isSmartRect: true,
              cornerConfig: cfg,
            });

            const idx = App.canvas.getObjects().indexOf(act);
            App.canvas.discardActiveObject().remove(act).insertAt(newObj, idx, true).setActiveObject(newObj).requestRenderAll();
            App.ui.updateInspector();
            App.history.saveState();
          },

          flip: function (dir) {
            const act = App.canvas.getActiveObject();
            if (!act) return;
            const prop = dir === "x" ? "flipX" : "flipY";
            if (act.type === "activeSelection") {
              const grp = act.toGroup();
              grp.set(prop, !grp[prop]);
              App.canvas.setActiveObject(grp.toActiveSelection());
            } else {
              act.set(prop, !act[prop]);
            }
            App.canvas.requestRenderAll();
            App.history.saveState();
          },
        },

        // --- UI 管理 ---
        ui: {
          updateGeo: function (key, val, targetObj = null) {
            const act = targetObj || App.canvas.getActiveObject();
            if (!act) return;

            if (val === undefined || val === null) {
              const p = act.getPointByOrigin("left", "top");
              document.getElementById("propX").value = Utils.px2mm(p.x).toFixed(1);
              document.getElementById("propY").value = Utils.px2mm(p.y).toFixed(1);
              document.getElementById("propAngle").value = Math.round(act.angle);
              document.getElementById("propW").value = Utils.px2mm(act.getScaledWidth()).toFixed(1);
              document.getElementById("propH").value = Utils.px2mm(act.getScaledHeight()).toFixed(1);
            } else {
              const numVal = parseFloat(val);
              if (isNaN(numVal)) return;

              if (key === "angle") {
                act.set("angle", numVal);
              } else {
                const pxVal = Utils.mm2px(numVal);
                if (key === "left" || key === "top") {
                  let cx = parseFloat(document.getElementById("propX").value);
                  let cy = parseFloat(document.getElementById("propY").value);
                  act.setPositionByOrigin(new fabric.Point(Utils.mm2px(key === "left" ? numVal : cx), Utils.mm2px(key === "top" ? numVal : cy)), "left", "top");
                } else if (key === "width") {
                  act.type === "textbox" ? act.set("width", pxVal) : act.set("scaleX", pxVal / act.width);
                } else if (key === "height") {
                  act.set("scaleY", pxVal / act.height);
                }
              }
              act.setCoords();
              App.canvas.requestRenderAll();
              App.history.saveState();
            }
          },

          setProp: function (key, val) {
            const act = App.canvas.getActiveObject();
            if (act) {
              act.type === "activeSelection" ? act.forEachObject((o) => o.set(key, val)) : act.set(key, val);
              App.canvas.requestRenderAll();
              App.history.saveState();
            }
          },

          updateLineDash: function () {
            const act = App.canvas.getActiveObject();
            if (!act || act.type !== "line") return;
            const v = parseInt(document.getElementById("lineDashVal").value) || 5;
            act.set("strokeDashArray", document.getElementById("lineDashCheck").checked ? [v, v] : null);
            App.canvas.requestRenderAll();
            App.history.saveState();
          },

          toggleStyle: function (style) {
            const act = App.canvas.getActiveObject();
            if (!act) return;
            if (style === "bold") act.set("fontWeight", act.fontWeight === "bold" ? "normal" : "bold");
            else if (style === "italic") act.set("fontStyle", act.fontStyle === "italic" ? "normal" : "italic");
            else if (style === "underline") act.set("underline", !act.underline);
            App.canvas.requestRenderAll();
            this.updateInspector();
            App.history.saveState();
          },

          updateInspector: function () {
            const act = App.canvas.getActiveObject();
            const ids = ["textProps", "imgProps", "lineProps", "shapeProps", "alignTools", "rectCornerControl", "selectionControls"];
            const els = {};
            ids.forEach((id) => {
              els[id] = document.getElementById(id);
              els[id]?.classList.add("hidden");
            });
            document.getElementById("noSelection").classList.toggle("hidden", !!act);

            if (!act) {
              this.updateLayerList();
              return;
            }

            els.selectionControls.classList.remove("hidden");
            this.updateGeo(null, null, act);
            document.getElementById("propOpacity").value = act.opacity || 1;
            document.getElementById("opacityVal").innerText = Math.round((act.opacity || 1) * 100) + "%";

            if (act.type === "activeSelection") els.alignTools.classList.remove("hidden");
            else if (["i-text", "textbox", "text"].includes(act.type)) {
              els.textProps.classList.remove("hidden");
              document.getElementById("propFont").value = act.fontFamily;
              document.getElementById("propSize").value = Utils.px2pt(act.fontSize);
              document.getElementById("propColor").value = act.fill;
              document.getElementById("propLineHeight").value = act.lineHeight || 1.2;
              document.getElementById("propCharSpacing").value = act.charSpacing || 0;
              document.getElementById("btnBold").classList.toggle("active", act.fontWeight === "bold");
              document.getElementById("btnItalic").classList.toggle("active", act.fontStyle === "italic");
              document.getElementById("btnUnderline").classList.toggle("active", !!act.underline);
            } else if (act.type === "image") {
              els.imgProps.classList.remove("hidden");
            } else if (act.type === "line") {
              els.lineProps.classList.remove("hidden");
              document.getElementById("lineColor").value = act.stroke;
              document.getElementById("lineStrokeWidth").value = act.strokeWidth;
              const dash = act.strokeDashArray;
              document.getElementById("lineDashCheck").checked = !!(dash && dash.length);
              document.getElementById("lineDashVal").value = (dash && dash[0]) || 5;
            } else if (["rect", "circle", "triangle", "polygon", "path"].includes(act.type)) {
              els.shapeProps.classList.remove("hidden");
              document.getElementById("shapeFill").value = act.fill === "transparent" ? "#ffffff" : act.fill;
              document.getElementById("shapeStroke").value = act.stroke || "#000000";
              document.getElementById("shapeStrokeWidth").value = act.strokeWidth || 0;

              if (act.type === "rect" || act.isSmartRect) {
                els.rectCornerControl.classList.remove("hidden");
                const conf = act.cornerConfig || { tl: act.rx || 0, tr: act.rx || 0, bl: act.rx || 0, br: act.rx || 0, style: "round" };
                document.getElementById("cornerStyle").value = conf.style;
                ["tl", "tr", "bl", "br"].forEach((k) => (document.getElementById("corner" + k.toUpperCase()).value = conf[k]));
                if (conf.tl === conf.tr && conf.tr === conf.bl && conf.bl === conf.br) {
                  document.getElementById("masterRadius").value = conf.tl;
                  document.getElementById("masterRadiusVal").innerText = conf.tl;
                }
              }
            }
            this.updateLayerList();
          },

          updateLayerList: function () {
            const list = document.getElementById("layerList");
            list.innerHTML = "";
            const objs = App.canvas
              .getObjects()
              .filter((o) => !o.isGrid)
              .reverse();
            const activeObjs = App.canvas.getActiveObjects();

            if (objs.length === 0 && !App.canvas.backgroundImage) {
              list.innerHTML = '<div class="text-gray-400 text-center py-4">暂无图层</div>';
              return;
            }

            const createRow = (icon, name, isActive, isBg, onClick, onDel) => {
              const div = document.createElement("div");
              div.className = `layer-item flex items-center justify-between px-2 py-2 border-b border-gray-100 last:border-0 cursor-pointer transition ${
                isActive ? "active" : isBg ? "bg-gray-50/80 italic text-slate-500" : "hover:bg-gray-50"
              }`;
              div.innerHTML = `<div class="flex items-center gap-2 w-full overflow-hidden"><i class="ph ${icon} ${isActive ? "text-blue-500" : "text-gray-400"}"></i><span class="truncate select-none text-xs ${
                isActive ? "font-bold" : ""
              }">${name}</span></div><button class="p-1 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded ml-2"><i class="ph ph-trash"></i></button>`;
              div.onclick = onClick;
              div.querySelector("button").onclick = (e) => {
                e.stopPropagation();
                onDel();
              };
              return div;
            };

            objs.forEach((o) => {
              let icon = "ph-square";
              if (o.type.includes("text")) icon = "ph-text-t";
              else if (o.type === "image") icon = "ph-image";
              else if (o.type === "line") icon = "ph-line-segment";
              else if (["rect", "circle", "triangle"].includes(o.type)) icon = "ph-shapes";

              list.appendChild(
                createRow(
                  icon,
                  o.text ? o.text.substring(0, 10) : o.type === "image" ? "图片" : o.type,
                  activeObjs.includes(o),
                  false,
                  (e) => {
                    if (e.ctrlKey) {
                      const newSel = activeObjs.includes(o) ? activeObjs.filter((i) => i !== o) : [...activeObjs, o];
                      App.canvas.setActiveObject(new fabric.ActiveSelection(newSel, { canvas: App.canvas }));
                    } else App.canvas.setActiveObject(o);
                    App.canvas.requestRenderAll();
                  },
                  () => {
                    App.canvas.remove(o);
                    App.canvas.discardActiveObject();
                    App.ui.updateLayerList();
                    App.history.saveState();
                  }
                )
              );
            });

            if (App.canvas.backgroundImage) {
              list.appendChild(
                createRow(
                  "ph-image-square",
                  "【背景】图片",
                  false,
                  true,
                  () => {},
                  () => {
                    if (confirm("移除背景?")) App.paper.clearBackground();
                  }
                )
              );
            }
          },

          moveLayer: function (dir) {
            const act = App.canvas.getActiveObject();
            if (!act) return;
            dir === "up" ? act.bringForward() : act.sendBackwards();
            App.canvas.getObjects().forEach((o) => o.isGrid && App.canvas.sendToBack(o));
            App.canvas.requestRenderAll();
            this.updateLayerList();
            App.history.saveState();
          },

          showLoading: (m) => {
            const el = document.getElementById("loadingOverlay");
            if (el) {
              el.querySelector("p").innerText = m;
              el.classList.remove("hidden");
            }
          },
          hideLoading: () => document.getElementById("loadingOverlay")?.classList.add("hidden"),
          toggleFullScreen: () => (!document.fullscreenElement ? document.documentElement.requestFullscreen() : document.exitFullscreen()),
          showModal: (id) => document.getElementById(id).classList.remove("hidden"),
          hideModal: (id) => document.getElementById(id).classList.add("hidden"),

          alignObject: function (mode) {
            const act = App.canvas.getActiveObject();
            if (!act) return;
            const cfg = App.paper.getSettings();
            const contentW = App.state.baseWidth - cfg.marginLeft - cfg.marginRight;
            if (mode === "centerH") act.set({ left: cfg.marginLeft + contentW / 2, originX: "center" });
            else if (mode === "left") act.set({ left: cfg.marginLeft, originX: "left" });
            else if (mode === "right") act.set({ left: App.state.baseWidth - cfg.marginRight, originX: "right" });
            act.setCoords();
            App.canvas.requestRenderAll();
            this.updateGeo(null, null, act);
            App.history.saveState();
          },

          align: function (mode) {
            if (App.state.selectionQueue.length < 2) return;
            const queue = [...App.state.selectionQueue],
              anchor = queue[0],
              aRect = anchor.getBoundingRect(true);
            App.canvas.discardActiveObject();
            queue.forEach((o) => o.setCoords());

            queue.forEach((obj) => {
              if (obj === anchor) return;
              const r = obj.getBoundingRect(true);
              let dx = 0,
                dy = 0;
              if (mode === "left") dx = aRect.left - r.left;
              else if (mode === "center") dx = aRect.left + aRect.width / 2 - (r.left + r.width / 2);
              else if (mode === "right") dx = aRect.left + aRect.width - (r.left + r.width);
              else if (mode === "top") dy = aRect.top - r.top;
              else if (mode === "middle") dy = aRect.top + aRect.height / 2 - (r.top + r.height / 2);
              else if (mode === "bottom") dy = aRect.top + aRect.height - (r.top + r.height);
              if (dx) obj.set("left", obj.left + dx);
              if (dy) obj.set("top", obj.top + dy);
              obj.setCoords();
            });
            App.canvas.setActiveObject(new fabric.ActiveSelection(queue, { canvas: App.canvas })).requestRenderAll();
            App.history.saveState();
          },

          distribute: function (mode) {
            const act = App.canvas.getActiveObject();
            if (!act || act.type !== "activeSelection" || act.getObjects().length < 3) return Utils.toast("至少需要3个元素", "info");

            const objs = act.getObjects();
            App.canvas.discardActiveObject();
            const isH = mode === "horizontal";
            objs.sort((a, b) => (isH ? a.left - b.left : a.top - b.top));

            const first = objs[0],
              last = objs[objs.length - 1];
            const getC = (o) => (isH ? o.getCenterPoint().x : o.getCenterPoint().y);
            const step = (getC(last) - getC(first)) / (objs.length - 1);

            objs.forEach((o, i) => {
              if (i === 0 || i === objs.length - 1) return;
              const target = getC(first) + step * i;
              const delta = target - getC(o);
              o.set(isH ? "left" : "top", (isH ? o.left : o.top) + delta).setCoords();
            });

            App.canvas.setActiveObject(new fabric.ActiveSelection(objs, { canvas: App.canvas })).requestRenderAll();
            this.updateInspector();
            App.history.saveState();
          },
        },

        // --- IO (存取/打印) ---
        io: {
          _getFontCss: () =>
            [...document.styleSheets]
              .flatMap((s) => {
                try {
                  return [...s.cssRules].filter((r) => r.type === CSSRule.FONT_FACE_RULE).map((r) => r.cssText);
                } catch {
                  return [];
                }
              })
              .join("\n"),

          _printAsImage: function () {
            const dataUrl = App.canvas.toDataURL({ format: "jpeg", quality: 0.9, multiplier: 3 });
            this._createPrintIframe(`<img src="${dataUrl}" onload="setTimeout(()=>window.print(),500);" style="width:100%">`);
            Utils.toast("已切换兼容模式打印");
          },

          _createPrintIframe: function (content, css = "") {
            const id = "print-iframe-sandbox";
            let f = document.getElementById(id);
            if (f) f.remove();
            f = document.createElement("iframe");
            f.id = id;
            f.style.cssText = "position:fixed;top:0;opacity:0;pointer-events:none;";
            document.body.appendChild(f);
            const doc = f.contentWindow.document;
            doc.open();
            doc.write(
              `<html><head><style>@page{size:${App.state.currentPaper.w}mm ${App.state.currentPaper.h}mm;margin:0}body{margin:0;display:flex;justify-content:center}${css}</style></head><body>${content}</body></html>`
            );
            doc.close();
          },

          print: async function () {
            try {
              const vC = await App.vector.getExportCanvas(false);
              vC.setViewportTransform([1, 0, 0, 1, 0, 0]);
              const svg = vC.toSVG({ suppressPreamble: true, viewBox: { x: 0, y: 0, width: App.state.baseWidth, height: App.state.baseHeight } });
              vC.dispose();
              this._createPrintIframe(`${svg}<script>setTimeout(()=>window.print(),500)<\/script>`, this._getFontCss());
              App.ui.hideLoading();
            } catch (e) {
              console.warn(e);
              App.ui.hideLoading();
              this._printAsImage();
            }
          },

          exportPDF: async function () {
            const btn = document.querySelector('button[onclick="App.io.exportPDF()"]');
            const oldTxt = btn ? btn.innerHTML : "";
            if (btn) {
              btn.disabled = true;
              btn.innerHTML = `<i class="ph ph-spinner animate-spin"></i> 处理中...`;
            }

            try {
              const vC = await App.vector.getExportCanvas(true);
              vC.setViewportTransform([1, 0, 0, 1, 0, 0]);
              const svg = vC.toSVG({ suppressPreamble: true, viewBox: { x: 0, y: 0, width: App.state.baseWidth, height: App.state.baseHeight } });
              vC.dispose();

              const { w, h } = App.state.currentPaper;
              const pdf = new window.jspdf.jsPDF({ orientation: w > h ? "l" : "p", unit: "mm", format: [w, h] });
              await pdf.svg(new DOMParser().parseFromString(svg, "image/svg+xml").documentElement, { x: 0, y: 0, width: w, height: h });
              pdf.save(`信笺纸_${Date.now()}.pdf`);
              Utils.toast("PDF 导出成功");
            } catch (e) {
              console.warn(e);
              Utils.toast("导出失败，请重试", "error");
            } finally {
              App.ui.hideLoading();
              if (btn) {
                btn.disabled = false;
                btn.innerHTML = oldTxt;
              }
            }
          },

          saveProject: function () {
            const json = App.canvas.toJSON(["id", "isGrid", "selectable", "evented"]);
            json.objects = json.objects.filter((o) => !o.isGrid);
            const blob = new Blob(
              [
                JSON.stringify({
                  version: "4.0",
                  timestamp: new Date().toISOString(),
                  settings: App.paper.getSettings(),
                  paperSize: document.getElementById("paperSize").value,
                  thumbnail: App.canvas.toDataURL({ format: "png", multiplier: 0.5 }),
                  canvasData: json,
                }),
              ],
              { type: "application/json" }
            );

            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = `信笺纸_${Date.now()}.paper`;
            a.click();
            URL.revokeObjectURL(a.href);
            Utils.toast("项目已保存");
            App.state.hasUnsavedChanges = false;
          },

          loadProjectData: function (data) {
            try {
              if (data.settings) {
                const s = data.settings;
                const setV = (id, v) => document.getElementById(id) && (document.getElementById(id).value = v);
                const setC = (id, v) => document.getElementById(id) && (document.getElementById(id).checked = v);

                setV("marginTop", Math.round(Utils.px2mm(s.marginTop)));
                setV("marginBottom", Math.round(Utils.px2mm(s.marginBottom)));
                setV("marginLeft", Math.round(Utils.px2mm(s.marginLeft)));
                setV("marginRight", Math.round(Utils.px2mm(s.marginRight)));
                setV("rowCount", s.rowCount);
                setV("gridColor", s.gridColor);
                setV("strokeWidth", s.strokeWidth);
                setV("paperBgColor", s.paperBgColor || "#ffffff");
                setC("doubleFirst", s.doubleFirst);
                setC("doubleLast", s.doubleLast);
                setC("gridDashed", s.gridDashed);
                setV("gridDashArray", s.gridDashArray);
                if (data.paperSize) setV("paperSize", data.paperSize);
              }
              App.paper.updateSize();
              App.canvas.clear();
              const done = () => {
                App.paper.drawGrid();
                App.ui.hideModal("welcomeModal");
                App.ui.updateLayerList();
                App.history.reset();
                App.state.hasUnsavedChanges = false;
                App.ui.hideLoading();
                document.getElementById("bgClearBtn").classList.toggle("hidden", !App.canvas.backgroundImage);
              };
              data.canvasData ? App.canvas.loadFromJSON(data.canvasData, done) : done();
            } catch (e) {
              Utils.toast("数据解析异常", "error");
              App.ui.hideLoading();
            }
          },

          loadProject: function (file) {
            if (!file) return;
            App.ui.showLoading("打开中...");
            const r = new FileReader();
            r.onload = (e) => {
              try {
                this.loadProjectData(JSON.parse(e.target.result));
              } catch {
                Utils.toast("文件格式错误", "error");
              } finally {
                App.ui.hideLoading();
              }
            };
            r.readAsText(file);
          },

          copy: function () {
            const act = App.canvas.getActiveObject();
            if (act)
              act.clone((c) => {
                App.state.clipboard = c;
                App.state.pasteCount = 0;
              });
          },

          paste: function () {
            if (!App.state.clipboard) return;
            App.state.pasteCount++;
            App.state.clipboard.clone((c) => {
              App.canvas.discardActiveObject();
              c.set({ left: c.left + 20 * App.state.pasteCount, top: c.top + 20 * App.state.pasteCount, evented: true });
              if (c.type === "activeSelection") {
                c.canvas = App.canvas;
                c.forEachObject((o) => App.canvas.add(o));
                c.setCoords();
              } else App.canvas.add(c);
              App.canvas.setActiveObject(c).requestRenderAll();
              App.ui.updateLayerList();
              App.history.saveState();
            });
          },
        },

        // --- 矢量导出辅助 ---
        vector: {
          fontCache: {},
          loadFont: async function (family) {
            if (this.fontCache[family]) return this.fontCache[family];
            const url = { "SourceHanSerifCN-Bold": "./static/SourceHanSerifCN-Bold.ttf" }[family];
            if (!url) return null;
            return new Promise((r) => opentype.load(url, (e, f) => r(e ? null : (this.fontCache[family] = f))));
          },

          getExportCanvas: async function (convertText) {
            App.ui.showLoading(convertText ? "文字转曲中..." : "准备打印数据...");
            const json = App.canvas.toJSON(["id", "isGrid", "selectable", "evented"]);

            // 强制包含网格
            const grids = App.canvas
              .getObjects()
              .filter((o) => o.isGrid)
              .map((o) => ({ ...o.toObject(["stroke", "strokeWidth", "strokeDashArray"]), excludeFromExport: false }));
            json.objects = [...grids, ...json.objects];

            const tC = new fabric.Canvas(null, { width: App.state.baseWidth, height: App.state.baseHeight, backgroundColor: App.paper.getSettings().paperBgColor });

            return new Promise((resolve) => {
              tC.loadFromJSON(json, async () => {
                if (convertText) {
                  const objs = tC.getObjects();
                  for (let i = 0; i < objs.length; i++) {
                    const o = objs[i];
                    if (!o.isGrid && ["i-text", "text", "textbox"].includes(o.type)) {
                      const f = await this.loadFont(o.fontFamily);
                      if (f) {
                        try {
                          const path = new fabric.Path(f.getPath(o.text, 0, 0, o.fontSize).toPathData(2), {
                            ...o.toObject(["fill", "stroke", "strokeWidth", "opacity", "scaleX", "scaleY", "angle", "shadow"]),
                            originX: "center",
                            originY: "center",
                          });
                          path.setPositionByOrigin(o.getCenterPoint(), "center", "center");
                          tC.insertAt(path, i, false);
                          tC.remove(o);
                        } catch {}
                      }
                    }
                  }
                }
                tC.renderAll();
                resolve(tC);
              });
            });
          },
        },

        // --- 模板系统 ---
        templates: {
          data: [],
          init: async function () {
            try {
              this.data = await (await fetch("./static/templates.json")).json();
              const grid = document.getElementById("templateGrid");
              if (grid) {
                grid.innerHTML = "";
                this.data.forEach((t) => {
                  const d = document.createElement("div");
                  d.className = "template-card bg-white p-3 rounded-xl border border-gray-200 cursor-pointer transition flex flex-col gap-2";
                  d.innerHTML = `<div class="h-36 bg-gray-50 rounded-lg overflow-hidden flex items-center justify-center border border-gray-100">${
                    t.thumbnail ? `<img src="${t.thumbnail}" class="h-full w-auto object-contain">` : '<i class="ph ph-file-plus text-3xl text-gray-300"></i>'
                  }</div><div><h3 class="font-bold text-slate-700 text-sm">${t.name}</h3><p class="text-slate-400 text-xs">${t.desc || "点击创建"}</p></div>`;
                  d.onclick = () => this.load(t.id);
                  grid.appendChild(d);
                });
              }
            } catch {
              Utils.toast("模板加载失败", "error");
            }
          },

          load: async function (id) {
            const t = this.data.find((i) => i.id === id);
            if (t?.url) {
              App.ui.showLoading("下载模板...");
              try {
                App.io.loadProjectData(await (await fetch(t.url)).json());
              } catch {
                Utils.toast("加载失败", "error");
                App.ui.hideLoading();
              }
            } else {
              App.ui.showLoading("创建中...");
              setTimeout(() => {
                ["paperSize", "marginTop", "marginBottom", "marginLeft", "marginRight", "rowCount", "gridColor", "strokeWidth"].forEach(
                  (k, i) => (document.getElementById(k).value = ["A4", 35, 35, 28, 28, 0, "#e11d48", 1][i])
                );
                document.getElementById("doubleFirst").checked = true;
                document.getElementById("doubleLast").checked = true;
                document.getElementById("gridDashed").checked = false;
                App.paper.updateSize();
                App.canvas.clear();
                App.paper.drawGrid();
                App.ui.hideModal("welcomeModal");
                App.ui.updateLayerList();
                App.history.reset();
                App.ui.hideLoading();
              }, 200);
            }
          },
        },
      };

      // --- 初始化绑定 ---
      function initHotkeys() {
        const isInput = () => ["INPUT", "TEXTAREA"].includes(document.activeElement?.tagName) || document.activeElement?.contentEditable === "true";

        hotkeys("ctrl+z,command+z", (e) => {
          if (!isInput()) {
            e.preventDefault();
            App.history.undo();
          }
        });
        hotkeys("ctrl+y,command+y", (e) => {
          if (!isInput()) {
            e.preventDefault();
            App.history.redo();
          }
        });
        hotkeys("ctrl+s,command+s", (e) => {
          e.preventDefault();
          App.io.saveProject();
        });
        hotkeys("ctrl+o,command+o", (e) => {
          e.preventDefault();
          document.getElementById("projectImportInput").click();
        });
        hotkeys("ctrl+p,command+p", (e) => {
          e.preventDefault();
          App.io.print();
        });
        hotkeys("del,backspace", (e) => {
          if (!isInput()) {
            e.preventDefault();
            App.tools.deleteActive();
          }
        });

        hotkeys("ctrl+c,command+c", (e) => {
          if (isInput() || window.getSelection()?.toString().length > 0) return;
          if (App.canvas.getActiveObject()) {
            e.preventDefault();
            App.io.copy();
          }
        });

        hotkeys("ctrl+v,command+v", (e) => {
          if (isInput()) return;
          if (App.state.clipboard) {
            e.preventDefault();
            App.io.paste();
          }
        });

        hotkeys("up,down,left,right", (e, h) => {
          if (!isInput() && App.canvas.getActiveObject()) {
            e.preventDefault();
            App.tools.nudge(h.key);
          }
        });
      }

      document.getElementById("imgUpload").onchange = function () {
        App.tools.handleImageUpload(this);
      };
      document.getElementById("projectImportInput").onchange = function () {
        App.io.loadProject(this.files[0]);
      };
      document.getElementById("imgReplaceInput").onchange = function () {
        App.tools.replaceActiveImage(this);
      };
      document.getElementById("welcomeModal").onclick = (e) => {
        if (e.target.id === "welcomeModal") App.ui.hideModal("welcomeModal");
      };

      document.addEventListener("fullscreenchange", () => {
        const icon = document.getElementById("fsIcon");
        icon.className = `ph ph-corners-${document.fullscreenElement ? "in" : "out"} text-lg`;
        setTimeout(() => App.zoom.autoFit(), 100);
      });

      window.onload = function () {
        App.init();
        App.templates.init();
        initHotkeys();
        window.onbeforeunload = () => (App.state.hasUnsavedChanges ? "未保存" : undefined);
      };
    </script>
  </body>
</html>
